{{!< layout}}

<section class="hero shop-hero">
  <p class="eyebrow">Tool Depot · Season {{season}}</p>
  <h2>Spend site pay without spamming chat.</h2>
  <p>Buy upgrades, sell dupes, keep the slab moving. Uses your Twitch name to link your profile.</p>
  <div id="shop-meta" data-authed="{{#if authed}}true{{else}}false{{/if}}" data-user="{{user}}"></div>
  {{#if authed}}
    <div class="shop-user">
      <p class="muted">Logged in as <strong>{{user}}</strong>. <a href="/auth/logout">Log out</a></p>
    </div>
  {{else}}
    <div class="shop-user">
      <label for="shop-user-input">Your Twitch name (or log in)</label>
      <input id="shop-user-input" type="text" placeholder="tradi3" value="{{user}}">
      {{#if oauthEnabled}}
        <a class="btn primary" href="/auth/twitch">Log in with Twitch</a>
      {{/if}}
      <button class="btn ghost" id="shop-save-user">Set name</button>
    </div>
    {{#if oauthEnabled}}
      <p class="muted">Log in with Twitch to bind purchases to your account.</p>
    {{/if}}
    {{#unless oauthEnabled}}
      <p class="muted small">Trust mode: name is taken from the field above.</p>
    {{/unless}}
  {{/if}}
  <p class="muted">Channel locked to #tradi3. Purchases auto-equip if they beat your current gear.</p>
</section>

<section class="grid shop-grid">
  <div class="card profile-mini">
    <div class="card-head">
      <span class="badge badge-accent">Your status</span>
      <h3>Profile snapshot</h3>
    </div>
    <div id="profile-info">
      {{#if authed}}
        <p class="muted">Logged in as {{user}}. Loading your profile…</p>
      {{else}}
        <p class="muted">Enter your Twitch name and press “Set name” to load your profile.</p>
      {{/if}}
    </div>
  </div>

  {{#each stock}}
    <div class="card product">
      <div class="card-head">
        <span class="badge rarity-{{this.rarity}}">{{this.rarity}}</span>
        <h3>{{this.name}}</h3>
      </div>
      <p class="muted">
        <span class="type-tag {{this.type}}">{{this.type}}</span>
        · +{{this.power}} · requires LVL {{this.level}}
      </p>
      <div class="product-footer">
        <span class="tag price">{{this.price}} coins</span>
        <button class="btn primary buy-btn" type="button" data-buy="{{this.id}}">Buy</button>
      </div>
    </div>
  {{/each}}
</section>

<div class="grid two">
  <div class="card highlight">
    <div class="card-head">
      <span class="badge badge-accent">Sell gear</span>
      <h3>Turn dupes into coins</h3>
    </div>
    <p class="muted">Grab an item ID from your inventory page, paste it here, and sell it back for a refund.</p>
    <div class="shop-sell">
      <input id="shop-sell-id" type="text" placeholder="item id from /inventory" />
      <button class="btn ghost" id="shop-sell-btn" type="button">Sell item</button>
    </div>
    <p class="muted small">Tip: Check <a href="/inventory/{{#if user}}{{user}}{{else}}tradi3{{/if}}">your inventory page</a> for item IDs.</p>
    {{#if oauthEnabled}}
      <p class="muted small">Login required for buy/sell. If buttons don't respond, ensure you're logged in.</p>
    {{/if}}
  </div>

  <div class="card">
    <div class="card-head">
      <span class="badge">How it works</span>
      <h3>Chat + Web flow</h3>
    </div>
    <ul class="mini-list">
      <li>Use this page for buying/selling to keep chat clean.</li>
      <li>Quest drops still happen via <code>!quest</code>.</li>
      <li>Boss and daily rewards unchanged.</li>
      <li>Shop stock rotates each season.</li>
    </ul>
    <p class="muted small">If you refresh or return, your Twitch name is remembered locally.</p>
  </div>
</div>

<div id="shop-status" class="status"></div>

<script>
(function() {
  const userInput = document.getElementById("shop-user-input");
  const saveBtn = document.getElementById("shop-save-user");
  const statusEl = document.getElementById("shop-status");
  const sellInput = document.getElementById("shop-sell-id");
  const sellBtn = document.getElementById("shop-sell-btn");
  const profileInfo = document.getElementById("profile-info");
  const meta = document.getElementById("shop-meta");
  const metaAuthed = meta ? meta.getAttribute("data-authed") : "";
  const authed = metaAuthed === "true";
  const metaUser = meta ? (meta.getAttribute("data-user") || "").trim().toLowerCase() : "";

  let buying = false;
  let selling = false;

  const storeKey = "cq-user";

  const setStatus = (text, isError = false) => {
    if (!statusEl) return;
    statusEl.textContent = text;
    statusEl.classList.toggle("error", isError);
  };

  const setProfileInfo = (html) => {
    if (!profileInfo) return;
    profileInfo.innerHTML = html;
  };

  function getUser() {
    if (authed && metaUser) return metaUser;
    if (!userInput) return "";
    return (userInput.value || "").trim().toLowerCase();
  }

  function saveUser() {
    const user = getUser();
    if (!user) {
      setStatus("Enter your Twitch name to use the shop.", true);
      return;
    }
    try {
      localStorage.setItem(storeKey, user);
    } catch (_) {}
    setStatus(`Using Twitch name: ${user}`);
    loadProfile(user);
  }

  function loadUser() {
    if (authed && metaUser) {
      if (userInput) {
        userInput.value = metaUser;
        userInput.disabled = true;
      }
      if (saveBtn) saveBtn.classList.add("hidden");
      setStatus(`Using Twitch login: ${metaUser}`);
      loadProfile(metaUser);
      return;
    }
    if (userInput.value) return;
    try {
      const saved = localStorage.getItem(storeKey);
      if (saved) {
        userInput.value = saved;
        setStatus(`Using Twitch name: ${saved}`);
        loadProfile(saved);
      }
    } catch (_) {}
  }

  async function loadProfile(user) {
    setProfileInfo(`<p class="muted">Loading profile for ${user}...</p>`);
    try {
      const res = await fetch(`/api/stats?user=${encodeURIComponent(user)}&channel=tradi3`);
      const text = await res.text();
      setProfileInfo(`<p>${text}</p>`);
    } catch (err) {
      setProfileInfo(`<p class="muted">Could not load profile.</p>`);
    }
  }

  async function buy(itemId) {
    if (buying) return;
    const user = getUser();
    if (!user) {
      setStatus("Enter your Twitch name first.", true);
      return;
    }
    if (!userInput.disabled && userInput.value && userInput.value !== user) {
      userInput.value = user;
    }
    buying = true;
    setStatus("Processing purchase...");
    try {
      const res = await fetch(`/api/shop/buy?user=${encodeURIComponent(user)}&channel=tradi3&item=${encodeURIComponent(itemId)}`, {
        credentials: "same-origin"
      });
      const text = await res.text();
      setStatus(text, res.status >= 400);
    } catch (err) {
      setStatus("Purchase failed. Please try again.", true);
    } finally {
      buying = false;
    }
  }

  async function sell() {
    if (selling) return;
    const user = getUser();
    const itemId = (sellInput.value || "").trim();
    if (!user || !itemId) {
      setStatus("Enter your Twitch name and an item ID.", true);
      return;
    }
    selling = true;
    setStatus("Selling item...");
    try {
      const res = await fetch(`/api/shop/sell?user=${encodeURIComponent(user)}&channel=tradi3&item=${encodeURIComponent(itemId)}`, {
        credentials: "same-origin"
      });
      const text = await res.text();
      setStatus(text, res.status >= 400);
    } catch (err) {
      setStatus("Sell failed. Please try again.", true);
    } finally {
      selling = false;
    }
  }

  document.querySelectorAll(".buy-btn").forEach((btn) => {
    btn.addEventListener("click", () => buy(btn.dataset.buy));
  });

  if (saveBtn) {
    saveBtn.addEventListener("click", saveUser);
  }
  if (sellBtn) {
    sellBtn.addEventListener("click", sell);
  }
  if (authed && metaUser) {
    setStatus(`Using Twitch login: ${metaUser}`);
  }
  loadUser();
})();
</script>
